steps:
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'sh'
    args:
      - '-c'
      - |
        echo "Retrieving secrets..."
        export REFRESH_TOKEN=$(gcloud secrets versions access latest --secret=REFRESH_TOKEN)
        export CLIENT_ID=$(gcloud secrets versions access latest --secret=CLIENT_ID)
        export CLIENT_SECRET=$(gcloud secrets versions access latest --secret=CLIENT_SECRET)
        echo "REFRESH_TOKEN=$REFRESH_TOKEN" >> .env
        echo "CLIENT_ID=$CLIENT_ID" >> .env
        echo "CLIENT_SECRET=$CLIENT_SECRET" >> .env

  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/wedding-photos', '.']
    env:
      - 'REFRESH_TOKEN=$(gcloud secrets versions access latest --secret=REFRESH_TOKEN)'
      - 'CLIENT_ID=$(gcloud secrets versions access latest --secret=CLIENT_ID)'
      - 'CLIENT_SECRET=$(gcloud secrets versions access latest --secret=CLIENT_SECRET)'

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'gcr.io/$PROJECT_ID/wedding-photos']

images:
  - 'gcr.io/$PROJECT_ID/wedding-photos'
